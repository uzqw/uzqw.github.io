<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Six Pitfalls Implementing HNSW: A Debug Journal from 0% to 98%+ Recall - zqw's notes</title><meta name=Description content="Implementing HNSW for a vector database project, hitting 0% recall on the first test, and systematically fixing six critical bugs: inverted heap semantics, distance/similarity confusion, lack of diversity heuristic in SelectNeighbors, and more. Each bug is traced back to the original HNSW paper."><meta property="og:url" content="https://uzqw.github.io/posts/260216-hnsw-implementation/"><meta property="og:site_name" content="zqw's notes"><meta property="og:title" content="Six Pitfalls Implementing HNSW: A Debug Journal from 0% to 98%+ Recall"><meta property="og:description" content="Implementing HNSW for a vector database project, hitting 0% recall on the first test, and systematically fixing six critical bugs: inverted heap semantics, distance/similarity confusion, lack of diversity heuristic in SelectNeighbors, and more. Each bug is traced back to the original HNSW paper."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-16T10:00:00+08:00"><meta property="article:modified_time" content="2026-02-16T10:00:00+08:00"><meta property="article:tag" content="HNSW"><meta property="article:tag" content="Vector Database"><meta property="article:tag" content="Go"><meta property="article:tag" content="ANN"><meta name=twitter:card content="summary"><meta name=twitter:title content="Six Pitfalls Implementing HNSW: A Debug Journal from 0% to 98%+ Recall"><meta name=twitter:description content="Implementing HNSW for a vector database project, hitting 0% recall on the first test, and systematically fixing six critical bugs: inverted heap semantics, distance/similarity confusion, lack of diversity heuristic in SelectNeighbors, and more. Each bug is traced back to the original HNSW paper."><meta name=application-name content="zqw's notes"><meta name=apple-mobile-web-app-title content="zqw's notes"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://uzqw.github.io/posts/260216-hnsw-implementation/><link rel=prev href=https://uzqw.github.io/posts/260213-temporal-reliability/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Six Pitfalls Implementing HNSW: A Debug Journal from 0% to 98%+ Recall","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/uzqw.github.io\/posts\/260216-hnsw-implementation\/"},"genre":"posts","keywords":"HNSW, Vector Database, Go, ANN","wordcount":1748,"url":"https:\/\/uzqw.github.io\/posts\/260216-hnsw-implementation\/","datePublished":"2026-02-16T10:00:00+08:00","dateModified":"2026-02-16T10:00:00+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Paul"},"description":"Implementing HNSW for a vector database project, hitting 0% recall on the first test, and systematically fixing six critical bugs: inverted heap semantics, distance/similarity confusion, lack of diversity heuristic in SelectNeighbors, and more. Each bug is traced back to the original HNSW paper."}</script><link rel=alternate hreflang=en href=https://uzqw.github.io/posts/260216-hnsw-implementation/><link rel=alternate hreflang=zh-CN href=https://uzqw.net/posts/260216-hnsw-implementation/><link rel=alternate hreflang=x-default href=https://uzqw.github.io/posts/260216-hnsw-implementation/></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="zqw's notes">zqw's notes</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/uzqw title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=Search... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=https://uzqw.github.io/posts/260216-hnsw-implementation/ selected>English</option><option value=https://uzqw.net/posts/260216-hnsw-implementation/>简体中文</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="zqw's notes">zqw's notes</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=Search... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/uzqw title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i></a><a href=javascript:void(0); class="menu-item theme-switch" title>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=https://uzqw.github.io/posts/260216-hnsw-implementation/ selected>English</option><option value=https://uzqw.net/posts/260216-hnsw-implementation/>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Six Pitfalls Implementing HNSW: A Debug Journal from 0% to 98%+ Recall</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Paul</a></span>&nbsp;<span class=post-category>included in <a href=/categories/database/><i class="far fa-folder fa-fw" aria-hidden=true></i>Database</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2026-02-16>2026-02-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1748 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;9 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-hnsw-paper-core-ideas>1. HNSW Paper Core Ideas</a><ul><li><a href=#11-layered-skip-list--proximity-graph>1.1 Layered Skip List + Proximity Graph</a></li><li><a href=#12-five-key-parameters>1.2 Five Key Parameters</a></li><li><a href=#13-two-critical-heaps>1.3 Two Critical Heaps</a></li><li><a href=#14-algorithm-4-diversity-heuristic-for-selectneighbors>1.4 Algorithm 4: Diversity Heuristic for SelectNeighbors</a></li></ul></li><li><a href=#2-first-shock-0-recall-across-the-board>2. First Shock: 0% Recall Across the Board</a><ul><li><a href=#21-test-framework>2.1 Test Framework</a></li><li><a href=#22-total-failure>2.2 Total Failure</a></li></ul></li><li><a href=#3-bug-1-distance-vs-similarity-confusion>3. Bug #1: Distance vs. Similarity Confusion</a><ul><li><a href=#31-root-cause>3.1 Root Cause</a></li><li><a href=#32-fix>3.2 Fix</a></li></ul></li><li><a href=#4-bug-2-inverted-candidate-selection-condition>4. Bug #2: Inverted Candidate Selection Condition</a></li><li><a href=#5-bugs-3-6-systematic-audit-against-the-paper>5. Bugs #3-#6: Systematic Audit Against the Paper</a><ul><li><a href=#51-bug-3-candidates-heap-semantics-most-fatal>5.1 Bug #3: candidates Heap Semantics (Most Fatal)</a></li><li><a href=#52-bug-4-selectneighbors-without-diversity-heuristic>5.2 Bug #4: SelectNeighbors Without Diversity Heuristic</a></li><li><a href=#53-bug-5-layer-0-not-using-m--2m>5.3 Bug #5: Layer 0 Not Using M₀ = 2M</a></li><li><a href=#54-bug-6-om-bubble-sort-in-pruneneighbors>5.4 Bug #6: O(M²) Bubble Sort in pruneNeighbors</a></li><li><a href=#55-additional-fixes>5.5 Additional Fixes</a></li></ul></li><li><a href=#6-results-after-all-six-fixes>6. Results After All Six Fixes</a></li><li><a href=#7-high-dimensional-performance-adaptive-ef>7. High-Dimensional Performance: Adaptive ef</a></li><li><a href=#8-gap-to-industrial-implementations>8. Gap to Industrial Implementations</a></li><li><a href=#9-debugging-methodology-takeaways>9. Debugging Methodology Takeaways</a></li></ul></nav></div></div><div class=content id=content><p>While implementing the HNSW algorithm for my vector database project <a href=https://github.com/uzqw/vex target=_blank rel="noopener noreffer">vex</a> (initial code AI-assisted, debugging and optimization done by hand), I ran my first Recall test — <strong>every single metric was 0%</strong>. Not 50%, not 30%. Zero. The HNSW results and BruteForce results had absolutely no overlap. This post documents the entire journey from 0% to 98%+ recall, cross-referencing each bug with the original HNSW paper.</p><h2 id=1-hnsw-paper-core-ideas>1. HNSW Paper Core Ideas</h2><p>Before diving into debugging, let&rsquo;s establish the foundational concepts from the HNSW paper (Malkov & Yashunin, 2018). Every bug we&rsquo;ll encounter maps directly to a violation of these principles.</p><h3 id=11-layered-skip-list--proximity-graph>1.1 Layered Skip List + Proximity Graph</h3><p>HNSW is a <strong>multi-layer graph</strong>. Upper layers are sparse (for long-range jumps), lower layers are dense (for precise search). Search starts from the entry point at the highest layer and greedily descends.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Layer 2:    [A] ──────────────── [B]              (sparse, long hops)
</span></span><span class=line><span class=cl>             │                    │
</span></span><span class=line><span class=cl>Layer 1:    [A] ── [C] ── [D] ── [B] ── [E]      (medium density)
</span></span><span class=line><span class=cl>             │      │      │      │      │
</span></span><span class=line><span class=cl>Layer 0:    [A]-[C]-[F]-[D]-[G]-[B]-[E]-[H]-...  (all nodes)
</span></span></code></pre></td></tr></table></div></div><p>Intuition: like map navigation — first hop on the highway to get near the target city, then switch to local roads, then walk the streets to the exact address.</p><h3 id=12-five-key-parameters>1.2 Five Key Parameters</h3><table><thead><tr><th>Parameter</th><th>Meaning</th><th>Paper Recommendation</th></tr></thead><tbody><tr><td>$M$</td><td>Max neighbors per node (non-zero layers)</td><td>12-48</td></tr><tr><td>$M_0$</td><td>Max neighbors at Layer 0, $M_0 = 2M$</td><td>Paper §4 explicitly requires this</td></tr><tr><td>$ef_{Construction}$</td><td>Candidate set size during build</td><td>100-400</td></tr><tr><td>$ef$</td><td>Candidate set size during search (beam width)</td><td>≥ k, typically 100-800</td></tr><tr><td>$m_L$</td><td>Level assignment factor, $m_L = 1/\ln(M)$</td><td>Computed automatically</td></tr></tbody></table><h3 id=13-two-critical-heaps>1.3 Two Critical Heaps</h3><p>Algorithm 2 (search) defines two heaps with strict semantics:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>C = min-heap (candidates)   -&gt; expand nearest candidate first
</span></span><span class=line><span class=cl>W = max-heap (working set)  -&gt; maintain top-ef results, evict worst
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Loop:
</span></span><span class=line><span class=cl>  1. Pop nearest from C (min-heap pop)
</span></span><span class=line><span class=cl>  2. If dist(c) &gt; worst in W -&gt; stop
</span></span><span class=line><span class=cl>  3. For each neighbor e of c:
</span></span><span class=line><span class=cl>  4.   If dist(e) &lt; worst in W -&gt; add to C and W
</span></span><span class=line><span class=cl>  5.   If |W| &gt; ef -&gt; pop worst from W (max-heap pop)
</span></span></code></pre></td></tr></table></div></div><p><strong>This is critical</strong> — inverting these heap semantics is the direct root cause of 0% recall.</p><h3 id=14-algorithm-4-diversity-heuristic-for-selectneighbors>1.4 Algorithm 4: Diversity Heuristic for SelectNeighbors</h3><p>The most overlooked contribution of the paper. Neighbor selection is <strong>not</strong> simply picking the M closest — it must consider spatial diversity:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Algorithm 4: SELECT-NEIGHBORS-HEURISTIC(q, C, M)
</span></span><span class=line><span class=cl>  R ← ∅ (result set)
</span></span><span class=line><span class=cl>  W ← C (working set, sorted by distance)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  while |W| &gt; 0 AND |R| &lt; M:
</span></span><span class=line><span class=cl>    e ← extract nearest from W
</span></span><span class=line><span class=cl>    if dist(q, e) &lt; dist(e, r) for all r ∈ R:  // e is not &#34;dominated&#34;
</span></span><span class=line><span class=cl>      R ← R ∪ {e}
</span></span><span class=line><span class=cl>    else:
</span></span><span class=line><span class=cl>      discard e  (already covered by an existing neighbor)
</span></span></code></pre></td></tr></table></div></div><p><strong>Intuition</strong>: if you&rsquo;re placing cell towers, don&rsquo;t cluster them all in the city center. Spread them across different directions so every area has coverage.</p><h2 id=2-first-shock-0-recall-across-the-board>2. First Shock: 0% Recall Across the Board</h2><h3 id=21-test-framework>2.1 Test Framework</h3><p>I built a Recall@K test. The idea is straightforward: insert the same vectors into both HNSW and BruteForce, query the same vectors, compute overlap:</p><p>$$Recall@k = \frac{|HNSW_{top\text{-}k} \cap BruteForce_{top\text{-}k}|}{k}$$</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>calculateRecallAtK</span><span class=p>(</span><span class=nx>hnswResults</span><span class=p>,</span><span class=w> </span><span class=nx>groundTruth</span><span class=w> </span><span class=p>[]</span><span class=nx>vector</span><span class=p>.</span><span class=nx>SearchResult</span><span class=p>,</span><span class=w> </span><span class=nx>k</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=kt>float64</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>truthSet</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>bool</span><span class=p>,</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>groundTruth</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>groundTruth</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>truthSet</span><span class=p>[</span><span class=nx>r</span><span class=p>.</span><span class=nx>Key</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>matches</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>hnswResults</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>truthSet</span><span class=p>[</span><span class=nx>r</span><span class=p>.</span><span class=nx>Key</span><span class=p>]</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>matches</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>float64</span><span class=p>(</span><span class=nx>matches</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=nb>float64</span><span class=p>(</span><span class=nx>k</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Test matrix: 6 configurations (1K/10K vectors × 128/256/512 dimensions).</p><h3 id=22-total-failure>2.2 Total Failure</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>=== RUN   TestHNSWRecallAccuracy/1K-128D
</span></span><span class=line><span class=cl>    recall@1   = 0.0000 (0.00%)
</span></span><span class=line><span class=cl>    recall@5   = 0.0000 (0.00%)
</span></span><span class=line><span class=cl>    recall@10  = 0.0000 (0.00%)
</span></span><span class=line><span class=cl>--- FAIL
</span></span></code></pre></td></tr></table></div></div><p>All 6 configurations, all k values: <strong>0.0000</strong>.</p><p>Debug output revealed the smoking gun:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Query: test-query-0
</span></span><span class=line><span class=cl>  HNSW top-5:  [vec-933(-0.22), vec-071(-0.21), vec-445(-0.19), ...]
</span></span><span class=line><span class=cl>  BF   top-5:  [vec-236(+0.30), vec-560(+0.29), vec-112(+0.28), ...]
</span></span><span class=line><span class=cl>  Overlap: 0/5 (0%)
</span></span></code></pre></td></tr></table></div></div><p>Two observations:</p><ol><li><strong>Zero overlap</strong> — not a sorting issue, entirely different vectors</li><li><strong>HNSW returned negative similarities</strong> (-0.22) while BF returned positive (+0.30)</li></ol><p>HNSW was returning the <strong>least similar</strong> vectors.</p><h2 id=3-bug-1-distance-vs-similarity-confusion>3. Bug #1: Distance vs. Similarity Confusion</h2><h3 id=31-root-cause>3.1 Root Cause</h3><p>The heap comparison logic assumed <strong>lower distance = better</strong> (like Euclidean), but the actual metric was <strong>DotProduct similarity</strong> (higher = better).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Original — returns raw similarity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>distanceBetween</span><span class=p>(</span><span class=nx>vec1</span><span class=p>,</span><span class=w> </span><span class=nx>vec2</span><span class=w> </span><span class=p>[]</span><span class=kt>float32</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kt>float32</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>vector</span><span class=p>.</span><span class=nf>DotProduct</span><span class=p>(</span><span class=nx>vec1</span><span class=p>,</span><span class=w> </span><span class=nx>vec2</span><span class=p>)</span><span class=w> </span><span class=c1>// range [-1, 1], higher = more similar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Heap — assumes lower = better</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>h</span><span class=w> </span><span class=nx>candidateHeap</span><span class=p>)</span><span class=w> </span><span class=nf>Less</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span><span class=w> </span><span class=nx>j</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>h</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>distance</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>h</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nx>distance</span><span class=w>  </span><span class=c1>// max-heap: largest at root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>The heap evicts the largest value — but the largest similarity is the <strong>best</strong> result. Search was expanding the worst candidates first.</p><h3 id=32-fix>3.2 Fix</h3><p>Convert similarity to distance by negation:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>distanceBetween</span><span class=p>(</span><span class=nx>vec1</span><span class=p>,</span><span class=w> </span><span class=nx>vec2</span><span class=w> </span><span class=p>[]</span><span class=kt>float32</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kt>float32</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sim</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>vector</span><span class=p>.</span><span class=nf>DotProduct</span><span class=p>(</span><span class=nx>vec1</span><span class=p>,</span><span class=w> </span><span class=nx>vec2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>-</span><span class=nx>sim</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>  </span><span class=c1>// higher similarity -&gt; lower distance (more negative)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Result (recall@1): 0% -> ~20% (1K-128D), ~15% (1K-256D), ~2% (10K-128D). Progress, but recall dropped sharply with higher dimensions and more data. Far from ideal.</p><h2 id=4-bug-2-inverted-candidate-selection-condition>4. Bug #2: Inverted Candidate Selection Condition</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Wrong: selects candidates with LARGER (worse) distance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=nx>distance</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>w</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>distance</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>w</span><span class=p>)</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>ef</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>...</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Correct: selects candidates with SMALLER (better) distance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=nx>distance</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>w</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>distance</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>w</span><span class=p>)</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>ef</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>...</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Result: ~20% -> ~30% (1K-128D), ~15% -> ~25% (1K-256D), ~2% -> ~5% (10K-128D). Better, but 10K was still terrible.</p><h2 id=5-bugs-3-6-systematic-audit-against-the-paper>5. Bugs #3-#6: Systematic Audit Against the Paper</h2><p>At this point, I did a full code review against the paper.</p><h3 id=51-bug-3-candidates-heap-semantics-most-fatal>5.1 Bug #3: candidates Heap Semantics (Most Fatal)</h3><p><strong>Paper</strong>: <code>candidates</code> = <strong>min-heap</strong>, <code>W</code> = <strong>max-heap</strong>.</p><p><strong>Implementation</strong>: Both were max-heaps. Every iteration popped the <strong>furthest</strong> candidate for expansion instead of the nearest.</p><p><strong>Fix</strong>: Change candidates to min-heap.</p><h3 id=52-bug-4-selectneighbors-without-diversity-heuristic>5.2 Bug #4: SelectNeighbors Without Diversity Heuristic</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Original — just truncate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>getNeighbors</span><span class=p>(</span><span class=nx>candidates</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>HNSWNode</span><span class=p>,</span><span class=w> </span><span class=nx>m</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>HNSWNode</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>candidates</span><span class=p>[:</span><span class=nx>m</span><span class=p>]</span><span class=w>  </span><span class=c1>// Picks M closest — fatal mistake</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Fix</strong>: Implement Algorithm 4 with RNG diversity heuristic — discard candidates dominated by already-selected neighbors:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>h</span><span class=w> </span><span class=o>*</span><span class=nx>HNSWIndex</span><span class=p>)</span><span class=w> </span><span class=nf>selectNeighborsHeuristic</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>query</span><span class=w> </span><span class=p>[]</span><span class=kt>float32</span><span class=p>,</span><span class=w> </span><span class=nx>candidates</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>HNSWNode</span><span class=p>,</span><span class=w> </span><span class=nx>m</span><span class=w> </span><span class=kt>int</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>HNSWNode</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>selected</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>HNSWNode</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=nx>m</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>e</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>candidates</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>selected</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nx>m</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>break</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>distQE</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>distanceBetween</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span><span class=w> </span><span class=nx>e</span><span class=p>.</span><span class=nx>Vector</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>dominated</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>selected</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>distER</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>distanceBetween</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>Vector</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Vector</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>distER</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>distQE</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>dominated</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=k>break</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>dominated</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>selected</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>selected</span><span class=p>,</span><span class=w> </span><span class=nx>e</span><span class=p>)</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>selected</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=53-bug-5-layer-0-not-using-m--2m>5.3 Bug #5: Layer 0 Not Using M₀ = 2M</h3><p>Paper §4 explicitly states Layer 0 should use double the neighbor count.</p><h3 id=54-bug-6-om-bubble-sort-in-pruneneighbors>5.4 Bug #6: O(M²) Bubble Sort in pruneNeighbors</h3><p>Replaced with <code>sort.Slice</code> for O(M log M).</p><h3 id=55-additional-fixes>5.5 Additional Fixes</h3><ul><li><strong>Global RNG race</strong>: <code>assignLevel()</code> used shared <code>rand.Float64()</code>. Fixed with per-index <code>rand.Rand</code>.</li><li><strong>Delete dangling pointers</strong>: Deletion didn&rsquo;t clean up neighbor references. Fixed with tombstone flags and reverse-reference cleanup.</li></ul><h2 id=6-results-after-all-six-fixes>6. Results After All Six Fixes</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1K-128D:   recall@1  = 100.00%   recall@10 = 100.00%   recall@100 = 100.00%
</span></span><span class=line><span class=cl>1K-256D:   recall@1  = 100.00%   recall@10 = 100.00%   recall@100 = 100.00%
</span></span><span class=line><span class=cl>10K-128D:  recall@1  = 100.00%   recall@10 = 100.00%   recall@100 = 100.00%
</span></span><span class=line><span class=cl>10K-256D:  recall@1  = 99.99%    recall@10 = 99.98%    recall@100 = 99.96% 
</span></span><span class=line><span class=cl>10K-512D:  recall@1  = 98.39%    recall@10 = 98.80%    recall@100 = 98.21% 
</span></span></code></pre></td></tr></table></div></div><p>From <strong>0% across the board</strong> to <strong>near 100% on 1K-10K/128D-256D, ~98% on 10K-512D</strong>. The last 2% on high-dimensional large-scale data is bounded by the curse of dimensionality and ef trade-offs — within expected range.</p><p>Impact breakdown (using 1K-128D recall@1 as the observation metric):</p><table><thead><tr><th>Bug</th><th>Type</th><th>recall Trend</th><th>Paper Section</th></tr></thead><tbody><tr><td>Distance/similarity confusion</td><td>Semantic</td><td>0% -> ~20%</td><td>Distance space convention</td></tr><tr><td>Search condition inverted</td><td>Logic</td><td>~20% -> ~30%</td><td>Algorithm 2 termination</td></tr><tr><td>candidates heap semantics</td><td>Data structure</td><td>~30% -> ~90%</td><td>Algorithm 2 (C = min-heap)</td></tr><tr><td>No SelectNeighbors diversity</td><td>Algorithm gap</td><td>~90% -> ~97%</td><td>Algorithm 4</td></tr><tr><td>Layer 0 missing M₀=2M</td><td>Parameter</td><td>~97% -> ~99%</td><td>§4 parameter spec</td></tr><tr><td>Bubble sort in pruneNeighbors</td><td>Performance</td><td>No recall impact</td><td>Engineering</td></tr></tbody></table><h2 id=7-high-dimensional-performance-adaptive-ef>7. High-Dimensional Performance: Adaptive ef</h2><p>After all bugs were fixed, <strong>10K-512D took 512+ seconds</strong>. The fix: scale ef inversely with dimension.</p><p>$$ef_{adaptive} = \frac{ef_{base}}{\sqrt{dim / dim_{ref}}}$$</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>h</span><span class=w> </span><span class=o>*</span><span class=nx>HNSWIndex</span><span class=p>)</span><span class=w> </span><span class=nf>adaptiveEf</span><span class=p>(</span><span class=nx>baseEf</span><span class=p>,</span><span class=w> </span><span class=nx>dim</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>refDim</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>128</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>dim</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=nx>refDim</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nx>baseEf</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ef</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>baseEf</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=nx>math</span><span class=p>.</span><span class=nf>Sqrt</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>dim</span><span class=p>)</span><span class=o>/</span><span class=nx>refDim</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>ef</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>M</span><span class=o>*</span><span class=mi>2</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>ef</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>M</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>ef</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><table><thead><tr><th>Dim</th><th>baseEf</th><th>adaptiveEf</th><th>Build Time</th><th>Avg Recall</th></tr></thead><tbody><tr><td>128D</td><td>600</td><td>600</td><td>~10s</td><td>~100%</td></tr><tr><td>256D</td><td>600</td><td>424</td><td>~20s</td><td>~99%</td></tr><tr><td>512D</td><td>600</td><td><strong>300</strong></td><td>87s (was 512s+)</td><td>~98%</td></tr></tbody></table><h2 id=8-gap-to-industrial-implementations>8. Gap to Industrial Implementations</h2><table><thead><tr><th>Dimension</th><th>Current</th><th>Industrial (hnswlib/Faiss/Weaviate)</th></tr></thead><tbody><tr><td>SelectNeighbors</td><td>Algorithm 4 RNG heuristic (done)</td><td>Same</td></tr><tr><td>Layer 0 M₀</td><td>2×M (done, paper §4)</td><td>Same</td></tr><tr><td>Distance calc</td><td>Go ASM + AVX2/AVX512 (done)</td><td>C/C++ SIMD, 2-4× faster</td></tr><tr><td>Concurrency</td><td>FNV sharded locks (done)</td><td>Lock-free insert / finer-grained locks</td></tr><tr><td>Memory layout</td><td><code>map[string]*Node</code> pointer chasing</td><td>Contiguous arrays, cache-friendly</td></tr><tr><td>Delete</td><td>Soft delete + neighbor cleanup (done)</td><td>Lazy deletion + graph reconnection</td></tr><tr><td>Quantization</td><td>None</td><td>Product Quantization, 4-16× memory reduction</td></tr><tr><td>Dynamic ef</td><td>Dimension-adaptive (done)</td><td>Per-query budget adaptive</td></tr><tr><td>Persistence</td><td>Full snapshot</td><td>mmap direct load, sub-second recovery</td></tr></tbody></table><p>The main bottlenecks now are <strong>memory layout</strong> and <strong>quantization</strong> — Go&rsquo;s map + pointer structure is CPU cache-unfriendly, and uncompressed high-dimensional vectors consume significant memory. These are the next optimization targets.</p><h2 id=9-debugging-methodology-takeaways>9. Debugging Methodology Takeaways</h2><ol><li><p><strong>Write the test framework before the algorithm</strong> — HNSW&rsquo;s Search never errors; it always &ldquo;succeeds&rdquo; with wrong results. Without Recall@K, you&rsquo;d never know.</p></li><li><p><strong>0% is easier to debug than 50%</strong> — it signals a systematic directional error, not random precision loss.</p></li><li><p><strong>Cross-reference the paper line by line</strong> — one flipped comparison operator is the difference between 0% and 92% recall.</p></li><li><p><strong>Don&rsquo;t lower thresholds to &ldquo;pass&rdquo; tests</strong> — I once lowered the required recall from 85% to 1% to make the test green. That&rsquo;s hiding the bug, not fixing it.</p></li><li><p><strong>Fix one variable at a time</strong> — the six bugs weren&rsquo;t found simultaneously. Fix one, re-run, observe the recall delta, then move to the next.</p></li></ol><hr><blockquote><p><strong>Project</strong>: <a href=https://github.com/uzqw/vex target=_blank rel="noopener noreffer">github.com/uzqw/vex</a> — A vector database implemented in Go with HNSW index, BruteForce index and snapshot persistence.</p><p><strong>Reference</strong>: Malkov, Y.A. & Yashunin, D.A. (2018). &ldquo;Efficient and robust approximate nearest neighbor search using Hierarchical Navigable Small World graphs.&rdquo; <em>IEEE TPAMI</em>.</p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2026-02-16</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://uzqw.github.io/posts/260216-hnsw-implementation/ data-title="Six Pitfalls Implementing HNSW: A Debug Journal from 0% to 98%+ Recall" data-hashtags="HNSW,Vector Database,Go,ANN"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://uzqw.github.io/posts/260216-hnsw-implementation/ data-hashtag=HNSW><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://uzqw.github.io/posts/260216-hnsw-implementation/ data-title="Six Pitfalls Implementing HNSW: A Debug Journal from 0% to 98%+ Recall"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://uzqw.github.io/posts/260216-hnsw-implementation/ data-title="Six Pitfalls Implementing HNSW: A Debug Journal from 0% to 98%+ Recall"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://uzqw.github.io/posts/260216-hnsw-implementation/ data-title="Six Pitfalls Implementing HNSW: A Debug Journal from 0% to 98%+ Recall"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/hnsw/>HNSW</a>,&nbsp;<a href=/tags/vector-database/>Vector Database</a>,&nbsp;<a href=/tags/go/>Go</a>,&nbsp;<a href=/tags/ann/>ANN</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/260213-temporal-reliability/ class=prev rel=prev title="Temporal Single-Node Reliability Deep Dive: How It Survives Server Crashes, Network Failures, and Rollback Errors"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Temporal Single-Node Reliability Deep Dive: How It Survives Server Crashes, Network Failures, and Rollback Errors</a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2026</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>xxxx</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:999},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOQtuhcM4C0KhX",darkTheme:"dark",emitMetadata:"0",inputPosition:"bottom",lang:"en",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"uzqw/uzqw.github.io-comments",repoId:"R_kgDOQtuhcA"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"3I0XV796PJ",algoliaIndex:"uzqw_blog_en",algoliaSearchKey:"a9b525cdbc6c909379811b8e4440f85d",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>