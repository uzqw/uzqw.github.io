<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Dive into K8s 02: Cilium Replaces Flannel — Goodbye VXLAN Tax, Hello eBPF Native Networking - zqw's notes</title><meta name=Description content="Last post we captured VXLAN's 50-byte encapsulation overhead with tcpdump. This time we swap Flannel for Cilium, eliminate that performance tax with eBPF, and visualize network topology with Hubble."><meta property="og:url" content="https://uzqw.github.io/posts/251210-dive-into-k8s-02/"><meta property="og:site_name" content="zqw's notes"><meta property="og:title" content="Dive into K8s 02: Cilium Replaces Flannel — Goodbye VXLAN Tax, Hello eBPF Native Networking"><meta property="og:description" content="Last post we captured VXLAN's 50-byte encapsulation overhead with tcpdump. This time we swap Flannel for Cilium, eliminate that performance tax with eBPF, and visualize network topology with Hubble."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-10T17:38:00+08:00"><meta property="article:modified_time" content="2025-12-10T17:38:00+08:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Cilium"><meta property="article:tag" content="EBPF"><meta name=twitter:card content="summary"><meta name=twitter:title content="Dive into K8s 02: Cilium Replaces Flannel — Goodbye VXLAN Tax, Hello eBPF Native Networking"><meta name=twitter:description content="Last post we captured VXLAN's 50-byte encapsulation overhead with tcpdump. This time we swap Flannel for Cilium, eliminate that performance tax with eBPF, and visualize network topology with Hubble."><meta name=application-name content="zqw's notes"><meta name=apple-mobile-web-app-title content="zqw's notes"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://uzqw.github.io/posts/251210-dive-into-k8s-02/><link rel=prev href=https://uzqw.github.io/posts/251207-dive-into-k8s-01/><link rel=next href=https://uzqw.github.io/posts/260213-temporal-reliability/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Dive into K8s 02: Cilium Replaces Flannel — Goodbye VXLAN Tax, Hello eBPF Native Networking","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/uzqw.github.io\/posts\/251210-dive-into-k8s-02\/"},"genre":"posts","keywords":"Kubernetes, Cilium, eBPF","wordcount":935,"url":"https:\/\/uzqw.github.io\/posts\/251210-dive-into-k8s-02\/","datePublished":"2025-12-10T17:38:00+08:00","dateModified":"2025-12-10T17:38:00+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Paul"},"description":"Last post we captured VXLAN's 50-byte encapsulation overhead with tcpdump. This time we swap Flannel for Cilium, eliminate that performance tax with eBPF, and visualize network topology with Hubble."}</script><link rel=alternate hreflang=en href=https://uzqw.github.io/posts/251210-dive-into-k8s-02/><link rel=alternate hreflang=zh-CN href=https://uzqw.net/posts/251210-dive-into-k8s-02/><link rel=alternate hreflang=x-default href=https://uzqw.github.io/posts/251210-dive-into-k8s-02/></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="zqw's notes">zqw's notes</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/uzqw title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=Search... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=https://uzqw.github.io/posts/251210-dive-into-k8s-02/ selected>English</option><option value=https://uzqw.net/posts/251210-dive-into-k8s-02/>简体中文</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="zqw's notes">zqw's notes</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=Search... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/uzqw title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i></a><a href=javascript:void(0); class="menu-item theme-switch" title>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=https://uzqw.github.io/posts/251210-dive-into-k8s-02/ selected>English</option><option value=https://uzqw.net/posts/251210-dive-into-k8s-02/>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Dive into K8s 02: Cilium Replaces Flannel — Goodbye VXLAN Tax, Hello eBPF Native Networking</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Paul</a></span>&nbsp;<span class=post-category>included in <a href=/categories/distributed-systems/><i class="far fa-folder fa-fw" aria-hidden=true></i>Distributed Systems</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2025-12-10>2025-12-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;935 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;5 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-why-switch-to-cilium>1. Why Switch to Cilium?</a><ul><li><a href=#11-revisiting-vxlans-cost>1.1 Revisiting VXLAN&rsquo;s Cost</a></li><li><a href=#12-ciliums-secret-weapon-ebpf>1.2 Cilium&rsquo;s Secret Weapon: eBPF</a></li></ul></li><li><a href=#2-environment-prep-clean-flannel-residue>2. Environment Prep: Clean Flannel Residue</a><ul><li><a href=#21-delete-flannel>2.1 Delete Flannel</a></li><li><a href=#22-clean-node-network-residue>2.2 Clean Node Network Residue</a></li></ul></li><li><a href=#3-installing-cilium>3. Installing Cilium</a><ul><li><a href=#31-using-cilium-cli>3.1 Using Cilium CLI</a></li><li><a href=#32-wait-and-verify>3.2 Wait and Verify</a></li></ul></li><li><a href=#4-ebpf-packet-capture-witnessing-zero-encapsulation>4. eBPF Packet Capture: Witnessing Zero Encapsulation</a><ul><li><a href=#41-deploy-test-pods>4.1 Deploy Test Pods</a></li><li><a href=#42-observe-traffic-with-hubble>4.2 Observe Traffic with Hubble</a></li><li><a href=#43-compare-capture-results>4.3 Compare Capture Results</a></li></ul></li><li><a href=#5-hubble-visualization-network-topology-at-a-glance>5. Hubble Visualization: Network Topology at a Glance</a><ul><li><a href=#51-launch-hubble-ui>5.1 Launch Hubble UI</a></li><li><a href=#52-hubble-cli-in-action>5.2 Hubble CLI in Action</a></li></ul></li><li><a href=#6-performance-comparison-data>6. Performance Comparison Data</a></li><li><a href=#7-implications-for-ai-infra>7. Implications for AI Infra</a><ul><li><a href=#71-why-does-ai-training-need-cilium-more>7.1 Why Does AI Training Need Cilium More?</a></li><li><a href=#72-going-further-rdma-and-gpudirect>7.2 Going Further: RDMA and GPUDirect</a></li></ul></li><li><a href=#8-summary>8. Summary</a></li></ul></nav></div></div><div class=content id=content><p>Last post, we hand-rolled Flannel in Kind cluster and witnessed the 50-byte per-packet VXLAN encapsulation overhead via tcpdump. This time, we replace Flannel with Cilium, leveraging eBPF to completely eliminate this &ldquo;network tax&rdquo;, and use Hubble for traffic visualization.</p><h2 id=1-why-switch-to-cilium>1. Why Switch to Cilium?</h2><h3 id=11-revisiting-vxlans-cost>1.1 Revisiting VXLAN&rsquo;s Cost</h3><p>In the previous post, we captured:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Outer UDP packet: 134 bytes
</span></span><span class=line><span class=cl>Inner ICMP packet: 84 bytes
</span></span><span class=line><span class=cl>Encapsulation overhead: 50 bytes (37%!)
</span></span></code></pre></td></tr></table></div></div><p>For typical web apps, 50 bytes is negligible. But in <strong>AI large model training</strong>:</p><ul><li><strong>AllReduce</strong> operations sync gradients across multiple GPUs</li><li>Each iteration can generate GB-level network traffic</li><li>Encap/decap <strong>CPU overhead</strong> consumes precious compute resources</li><li><strong>Latency jitter</strong> means the slowest card drags down entire training</li></ul><h3 id=12-ciliums-secret-weapon-ebpf>1.2 Cilium&rsquo;s Secret Weapon: eBPF</h3><p>Cilium uses eBPF (Extended Berkeley Packet Filter) to handle packets directly in kernel space, without going through traditional iptables or VXLAN encapsulation:</p><table><thead><tr><th>Feature</th><th>Flannel (VXLAN)</th><th>Cilium (eBPF)</th></tr></thead><tbody><tr><td>Encapsulation overhead</td><td>50 bytes/packet</td><td>0 (Direct Routing)</td></tr><tr><td>NAT implementation</td><td>iptables (userspace rules)</td><td>eBPF (kernel)</td></tr><tr><td>Network policies</td><td>Depends on kube-proxy</td><td>Native support</td></tr><tr><td>Observability</td><td>Needs external tools</td><td>Hubble built-in</td></tr></tbody></table><h2 id=2-environment-prep-clean-flannel-residue>2. Environment Prep: Clean Flannel Residue</h2><h3 id=21-delete-flannel>2.1 Delete Flannel</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Delete Flannel DaemonSet and config</span>
</span></span><span class=line><span class=cl>kubectl delete -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Wait for flannel pods to fully delete</span>
</span></span><span class=line><span class=cl>kubectl get pods -n kube-flannel -w
</span></span></code></pre></td></tr></table></div></div><h3 id=22-clean-node-network-residue>2.2 Clean Node Network Residue</h3><p>This step is critical — otherwise it conflicts with Cilium:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Execute on each Kind node</span>
</span></span><span class=line><span class=cl><span class=k>for</span> node in kind-control-plane kind-worker<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  docker <span class=nb>exec</span> <span class=nv>$node</span> bash -c <span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    # Delete flannel bridges
</span></span></span><span class=line><span class=cl><span class=s2>    ip link delete cni0 2&gt;/dev/null || true
</span></span></span><span class=line><span class=cl><span class=s2>    ip link delete flannel.1 2&gt;/dev/null || true
</span></span></span><span class=line><span class=cl><span class=s2>    # Clean CNI config
</span></span></span><span class=line><span class=cl><span class=s2>    rm -rf /etc/cni/net.d/*
</span></span></span><span class=line><span class=cl><span class=s2>    # Clean iptables rules
</span></span></span><span class=line><span class=cl><span class=s2>    iptables -F -t nat
</span></span></span><span class=line><span class=cl><span class=s2>    iptables -F -t filter
</span></span></span><span class=line><span class=cl><span class=s2>  &#34;</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>War Story</strong>: First time I skipped this step, Cilium installed but Pod networking was chaos. <code>cilium status</code> reported &ldquo;BPF NodePort: Disabled&rdquo; and Pods couldn&rsquo;t communicate. Spent hours in logs before discovering <code>cni0</code> bridge wasn&rsquo;t cleaned properly.</p><h2 id=3-installing-cilium>3. Installing Cilium</h2><h3 id=31-using-cilium-cli>3.1 Using Cilium CLI</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Install Cilium CLI</span>
</span></span><span class=line><span class=cl><span class=nv>CILIUM_CLI_VERSION</span><span class=o>=</span><span class=k>$(</span>curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class=k>)</span>
</span></span><span class=line><span class=cl>curl -L --fail --remote-name-all <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  https://github.com/cilium/cilium-cli/releases/download/<span class=si>${</span><span class=nv>CILIUM_CLI_VERSION</span><span class=si>}</span>/cilium-linux-amd64.tar.gz
</span></span><span class=line><span class=cl>sudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
</span></span><span class=line><span class=cl>rm cilium-linux-amd64.tar.gz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Install Cilium (native routing mode, disable encapsulation)</span>
</span></span><span class=line><span class=cl>cilium install --version 1.14.5 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set <span class=nv>routingMode</span><span class=o>=</span>native <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set <span class=nv>autoDirectNodeRoutes</span><span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set <span class=nv>kubeProxyReplacement</span><span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set hubble.relay.enabled<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set hubble.ui.enabled<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><p>Key parameters explained:</p><ul><li><code>routingMode=native</code>: Use direct routing instead of encapsulation</li><li><code>kubeProxyReplacement=true</code>: Completely replace kube-proxy with eBPF</li><li><code>hubble.relay.enabled=true</code>: Enable Hubble observability</li></ul><h3 id=32-wait-and-verify>3.2 Wait and Verify</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Wait for Cilium ready</span>
</span></span><span class=line><span class=cl>cilium status --wait
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Run connectivity test</span>
</span></span><span class=line><span class=cl>cilium connectivity <span class=nb>test</span>
</span></span></code></pre></td></tr></table></div></div><p>Success output:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>All 46 tests (325 actions) successful, 2 tests skipped, 1 scenario skipped.
</span></span></code></pre></td></tr></table></div></div><h2 id=4-ebpf-packet-capture-witnessing-zero-encapsulation>4. eBPF Packet Capture: Witnessing Zero Encapsulation</h2><h3 id=41-deploy-test-pods>4.1 Deploy Test Pods</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Deploy Pods on both nodes</span>
</span></span><span class=line><span class=cl>kubectl run client --image<span class=o>=</span>nicolaka/netshoot --command -- sleep infinity
</span></span><span class=line><span class=cl>kubectl run server --image<span class=o>=</span>nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Wait for ready</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>wait</span> --for<span class=o>=</span><span class=nv>condition</span><span class=o>=</span>Ready pod/client pod/server
</span></span></code></pre></td></tr></table></div></div><h3 id=42-observe-traffic-with-hubble>4.2 Observe Traffic with Hubble</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Start Hubble CLI</span>
</span></span><span class=line><span class=cl>cilium hubble port-forward <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Observe traffic</span>
</span></span><span class=line><span class=cl>hubble observe --pod client --protocol TCP
</span></span></code></pre></td></tr></table></div></div><h3 id=43-compare-capture-results>4.3 Compare Capture Results</h3><p>In Cilium&rsquo;s Native Routing mode:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Capture on node</span>
</span></span><span class=line><span class=cl><span class=nv>PID</span><span class=o>=</span><span class=k>$(</span>docker inspect --format <span class=s1>&#39;{{.State.Pid}}&#39;</span> kind-control-plane<span class=k>)</span>
</span></span><span class=line><span class=cl>sudo nsenter -t <span class=nv>$PID</span> -n tcpdump -i eth0 host 10.244.1.5 -n
</span></span></code></pre></td></tr></table></div></div><p>Capture result:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>IP 10.244.0.3 &gt; 10.244.1.5: ICMP echo request, id 1, seq 1, length 64
</span></span><span class=line><span class=cl>IP 10.244.1.5 &gt; 10.244.0.3: ICMP echo reply, id 1, seq 1, length 64
</span></span></code></pre></td></tr></table></div></div><p><strong>Key Findings</strong>:</p><ul><li><strong>No UDP encapsulation</strong>! Directly seeing Pod IP to Pod IP ICMP packets</li><li>Packet only 84 bytes, compared to Flannel&rsquo;s 134 bytes</li><li>Encapsulation overhead: <strong>0 bytes</strong></li></ul><h2 id=5-hubble-visualization-network-topology-at-a-glance>5. Hubble Visualization: Network Topology at a Glance</h2><h3 id=51-launch-hubble-ui>5.1 Launch Hubble UI</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cilium hubble ui
</span></span></code></pre></td></tr></table></div></div><p>Open browser at <code>http://localhost:12000</code>:</p><p><strong>What Hubble UI shows</strong>:</p><ul><li>Real-time traffic relationship graph</li><li>Protocol, port, bytes for each connection</li><li>Network policy hit status</li><li>DNS query tracing</li></ul><h3 id=52-hubble-cli-in-action>5.2 Hubble CLI in Action</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># View all DROP&#39;d packets (debug network policy issues)</span>
</span></span><span class=line><span class=cl>hubble observe --verdict DROPPED
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Trace all connections for specific Pod</span>
</span></span><span class=line><span class=cl>hubble observe --pod kube-system/coredns --follow
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Export to JSON for analysis</span>
</span></span><span class=line><span class=cl>hubble observe --output json &gt; network-flows.json
</span></span></code></pre></td></tr></table></div></div><h2 id=6-performance-comparison-data>6. Performance Comparison Data</h2><p>Simple iperf3 test on Kind cluster:</p><table><thead><tr><th>Metric</th><th>Flannel (VXLAN)</th><th>Cilium (Native)</th><th>Improvement</th></tr></thead><tbody><tr><td>Throughput</td><td>8.2 Gbps</td><td>9.4 Gbps</td><td>+15%</td></tr><tr><td>Latency (P99)</td><td>0.42 ms</td><td>0.31 ms</td><td>-26%</td></tr><tr><td>CPU usage</td><td>12%</td><td>5%</td><td>-58%</td></tr></tbody></table><p><em>Note: Test environment is limited; real production improvements may be greater.</em></p><h2 id=7-implications-for-ai-infra>7. Implications for AI Infra</h2><h3 id=71-why-does-ai-training-need-cilium-more>7.1 Why Does AI Training Need Cilium More?</h3><ol><li><strong>AllReduce traffic characteristics</strong>: Lots of small packets, bursty traffic, latency-sensitive</li><li><strong>Ring/Tree AllReduce</strong> topologies make every node a traffic hotspot</li><li><strong>GPU time is precious</strong>: Network wait = GPU idle = burning money</li></ol><h3 id=72-going-further-rdma-and-gpudirect>7.2 Going Further: RDMA and GPUDirect</h3><p>Cilium is just the first step. True high-end AI Infra needs:</p><ul><li><strong>RDMA over Converged Ethernet (RoCE)</strong>: Bypass kernel, direct memory access</li><li><strong>GPUDirect RDMA</strong>: GPU directly reads/writes remote GPU memory</li></ul><p>Cilium&rsquo;s Native Routing mode paves the way for these advanced technologies by eliminating Overlay network constraints.</p><h2 id=8-summary>8. Summary</h2><table><thead><tr><th>Step</th><th>Takeaway</th></tr></thead><tbody><tr><td>Clean Flannel</td><td>Deep understanding of CNI plugin architecture</td></tr><tr><td>Install Cilium</td><td>Master eBPF network mode configuration</td></tr><tr><td>Compare captures</td><td>Quantify elimination of encapsulation overhead</td></tr><tr><td>Hubble visualization</td><td>Gain production-grade network observability</td></tr></tbody></table><p><strong>Next Plan</strong>: Deploy PyTorch distributed training on multi-node cluster, compare actual training throughput impact between Flannel and Cilium.</p><hr><blockquote><p><strong>Series</strong></p><ul><li><a href=/posts/251207-dive-into-k8s-01/ rel>Previous: Dive into K8s 01 — Hand-Rolling CNI with Kind, From CrashLoop to VXLAN Packet Capture</a></li><li>Next: Dive into K8s 03 — eBPF Deep Dive: Hand-Writing a Simple CNI Plugin (Planned)</li></ul></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2025-12-10</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://uzqw.github.io/posts/251210-dive-into-k8s-02/ data-title="Dive into K8s 02: Cilium Replaces Flannel — Goodbye VXLAN Tax, Hello eBPF Native Networking" data-hashtags=Kubernetes,Cilium,eBPF><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://uzqw.github.io/posts/251210-dive-into-k8s-02/ data-hashtag=Kubernetes><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://uzqw.github.io/posts/251210-dive-into-k8s-02/ data-title="Dive into K8s 02: Cilium Replaces Flannel — Goodbye VXLAN Tax, Hello eBPF Native Networking"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://uzqw.github.io/posts/251210-dive-into-k8s-02/ data-title="Dive into K8s 02: Cilium Replaces Flannel — Goodbye VXLAN Tax, Hello eBPF Native Networking"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://uzqw.github.io/posts/251210-dive-into-k8s-02/ data-title="Dive into K8s 02: Cilium Replaces Flannel — Goodbye VXLAN Tax, Hello eBPF Native Networking"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/kubernetes/>Kubernetes</a>,&nbsp;<a href=/tags/cilium/>Cilium</a>,&nbsp;<a href=/tags/ebpf/>EBPF</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/251207-dive-into-k8s-01/ class=prev rel=prev title="Dive into K8s: Hand-Rolling CNI with Kind, From CrashLoop to VXLAN Packet Capture"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Dive into K8s: Hand-Rolling CNI with Kind, From CrashLoop to VXLAN Packet Capture</a>
<a href=/posts/260213-temporal-reliability/ class=next rel=next title="Temporal Single-Node Reliability Deep Dive: How It Survives Server Crashes, Network Failures, and Rollback Errors">Temporal Single-Node Reliability Deep Dive: How It Survives Server Crashes, Network Failures, and Rollback Errors<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2026</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>xxxx</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:999},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOQtuhcM4C0KhX",darkTheme:"dark",emitMetadata:"0",inputPosition:"bottom",lang:"en",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"uzqw/uzqw.github.io-comments",repoId:"R_kgDOQtuhcA"}},search:{algoliaAppID:"3I0XV796PJ",algoliaIndex:"uzqw_blog_en",algoliaSearchKey:"a9b525cdbc6c909379811b8e4440f85d",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>