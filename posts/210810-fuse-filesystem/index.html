<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Building a Mini Filesystem: Custom FS with FUSE + Go - zqw's notes</title><meta name=Description content="Using FUSE framework and Go to implement a simple userspace filesystem from scratch. Deep dive into core concepts like inode, block, and file operations."><meta property="og:url" content="https://uzqw.github.io/posts/210810-fuse-filesystem/"><meta property="og:site_name" content="zqw's notes"><meta property="og:title" content="Building a Mini Filesystem: Custom FS with FUSE + Go"><meta property="og:description" content="Using FUSE framework and Go to implement a simple userspace filesystem from scratch. Deep dive into core concepts like inode, block, and file operations."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-10T10:00:00+08:00"><meta property="article:modified_time" content="2021-08-10T10:00:00+08:00"><meta property="article:tag" content="Filesystem"><meta property="article:tag" content="FUSE"><meta property="article:tag" content="Go"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building a Mini Filesystem: Custom FS with FUSE + Go"><meta name=twitter:description content="Using FUSE framework and Go to implement a simple userspace filesystem from scratch. Deep dive into core concepts like inode, block, and file operations."><meta name=application-name content="zqw's notes"><meta name=apple-mobile-web-app-title content="zqw's notes"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://uzqw.github.io/posts/210810-fuse-filesystem/><link rel=prev href=https://uzqw.github.io/posts/210703-lru-learning/><link rel=next href=https://uzqw.github.io/posts/210922-go-feature/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Building a Mini Filesystem: Custom FS with FUSE + Go","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/uzqw.github.io\/posts\/210810-fuse-filesystem\/"},"genre":"posts","keywords":"Filesystem, FUSE, Go","wordcount":1619,"url":"https:\/\/uzqw.github.io\/posts\/210810-fuse-filesystem\/","datePublished":"2021-08-10T10:00:00+08:00","dateModified":"2021-08-10T10:00:00+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Paul"},"description":"Using FUSE framework and Go to implement a simple userspace filesystem from scratch. Deep dive into core concepts like inode, block, and file operations."}</script><link rel=alternate hreflang=en href=https://uzqw.github.io/posts/210810-fuse-filesystem/><link rel=alternate hreflang=zh-CN href=https://uzqw.net/posts/210810-fuse-filesystem/><link rel=alternate hreflang=x-default href=https://uzqw.github.io/posts/210810-fuse-filesystem/></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="zqw's notes">zqw's notes</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/uzqw title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=Search... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=https://uzqw.github.io/posts/210810-fuse-filesystem/ selected>English</option><option value=https://uzqw.net/posts/210810-fuse-filesystem/>简体中文</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="zqw's notes">zqw's notes</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=Search... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/uzqw title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i></a><a href=javascript:void(0); class="menu-item theme-switch" title>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=https://uzqw.github.io/posts/210810-fuse-filesystem/ selected>English</option><option value=https://uzqw.net/posts/210810-fuse-filesystem/>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Building a Mini Filesystem: Custom FS with FUSE + Go</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Paul</a></span>&nbsp;<span class=post-category>included in <a href=/categories/linux/><i class="far fa-folder fa-fw" aria-hidden=true></i>Linux</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-08-10>2021-08-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1619 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;8 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-why-build-your-own-filesystem>1. Why Build Your Own Filesystem?</a><ul><li><a href=#11-learning-goals>1.1 Learning Goals</a></li><li><a href=#12-fuse-advantages>1.2 FUSE Advantages</a></li></ul></li><li><a href=#2-filesystem-core-concepts>2. Filesystem Core Concepts</a><ul><li><a href=#21-inode>2.1 Inode</a></li><li><a href=#22-block>2.2 Block</a></li><li><a href=#23-directory>2.3 Directory</a></li><li><a href=#24-relationship-diagram>2.4 Relationship Diagram</a></li></ul></li><li><a href=#3-fuse-architecture>3. FUSE Architecture</a><ul><li><a href=#31-how-it-works>3.1 How It Works</a></li><li><a href=#32-operations-to-implement>3.2 Operations to Implement</a></li></ul></li><li><a href=#4-go-implementation>4. Go Implementation</a><ul><li><a href=#41-dependencies>4.1 Dependencies</a></li><li><a href=#42-data-structures>4.2 Data Structures</a></li><li><a href=#43-implementing-fuse-interface>4.3 Implementing FUSE Interface</a></li><li><a href=#44-file-operations>4.4 File Operations</a></li><li><a href=#45-main-program>4.5 Main Program</a></li></ul></li><li><a href=#5-test-run>5. Test Run</a></li><li><a href=#6-advanced-extensions>6. Advanced Extensions</a><ul><li><a href=#61-persist-to-disk>6.1 Persist to Disk</a></li><li><a href=#62-network-filesystem>6.2 Network Filesystem</a></li></ul></li><li><a href=#7-summary>7. Summary</a></li></ul></nav></div></div><div class=content id=content><p>The best way to learn filesystems is to write one yourself. This post uses FUSE + Go to implement an in-memory filesystem with basic read/write operations, deep-diving into core concepts like inode and block.</p><h2 id=1-why-build-your-own-filesystem>1. Why Build Your Own Filesystem?</h2><h3 id=11-learning-goals>1.1 Learning Goals</h3><p>Understanding filesystems is foundational for:</p><ul><li>Container storage volumes</li><li>Distributed storage (Ceph, GlusterFS)</li><li>Object storage (S3 FUSE)</li><li>Database storage engines</li></ul><h3 id=12-fuse-advantages>1.2 FUSE Advantages</h3><p><strong>FUSE (Filesystem in Userspace)</strong> allows implementing filesystems in userspace:</p><ul><li>No kernel modules needed</li><li>Easy development and debugging</li><li>Can use high-level languages (Go, Python, Rust)</li></ul><h2 id=2-filesystem-core-concepts>2. Filesystem Core Concepts</h2><h3 id=21-inode>2.1 Inode</h3><p><strong>Inode</strong> (Index Node) is the core data structure storing file metadata:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Inode</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ID</span><span class=w>         </span><span class=kt>uint64</span><span class=w>       </span><span class=c1>// inode number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Type</span><span class=w>       </span><span class=nx>InodeType</span><span class=w>    </span><span class=c1>// file or directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Size</span><span class=w>       </span><span class=kt>uint64</span><span class=w>       </span><span class=c1>// file size</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Mode</span><span class=w>       </span><span class=nx>os</span><span class=p>.</span><span class=nx>FileMode</span><span class=w>  </span><span class=c1>// permissions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Uid</span><span class=p>,</span><span class=w> </span><span class=nx>Gid</span><span class=w>   </span><span class=kt>uint32</span><span class=w>       </span><span class=c1>// owner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Atime</span><span class=w>      </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>    </span><span class=c1>// access time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Mtime</span><span class=w>      </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>    </span><span class=c1>// modification time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Ctime</span><span class=w>      </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>    </span><span class=c1>// creation time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Links</span><span class=w>      </span><span class=kt>uint32</span><span class=w>       </span><span class=c1>// hard link count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Blocks</span><span class=w>     </span><span class=p>[]</span><span class=kt>uint64</span><span class=w>     </span><span class=c1>// data block indices</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Key points</strong>:</p><ul><li>Filename is NOT in inode! Filenames are in <strong>directory entries</strong></li><li>One inode can have multiple filenames (hard links)</li><li><code>ls -i</code> shows inode numbers</li></ul><h3 id=22-block>2.2 Block</h3><p><strong>Block</strong> is the basic storage unit, typically 4KB:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span><span class=w> </span><span class=nx>BlockSize</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>4096</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Block</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Data</span><span class=w> </span><span class=p>[</span><span class=nx>BlockSize</span><span class=p>]</span><span class=kt>byte</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>File contents are split into multiple Blocks.</p><h3 id=23-directory>2.3 Directory</h3><p>A directory is essentially a file whose contents are a list of &ldquo;directory entries&rdquo;:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>DirEntry</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Name</span><span class=w>   </span><span class=kt>string</span><span class=w>  </span><span class=c1>// filename</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Inode</span><span class=w>  </span><span class=kt>uint64</span><span class=w>  </span><span class=c1>// points to inode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Directory content is []DirEntry</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=24-relationship-diagram>2.4 Relationship Diagram</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           ┌─────────────────────────────────────────┐
</span></span><span class=line><span class=cl>           │              Superblock                 │
</span></span><span class=line><span class=cl>           │  (FS metadata: block count, inode count) │
</span></span><span class=line><span class=cl>           └─────────────────────────────────────────┘
</span></span><span class=line><span class=cl>                              │
</span></span><span class=line><span class=cl>     ┌────────────────────────┼────────────────────────┐
</span></span><span class=line><span class=cl>     ▼                        ▼                        ▼
</span></span><span class=line><span class=cl>┌─────────┐            ┌─────────┐             ┌─────────┐
</span></span><span class=line><span class=cl>│ Inode 1 │            │ Inode 2 │             │ Inode 3 │
</span></span><span class=line><span class=cl>│ (root)  │            │ (file a)│             │ (file b)│
</span></span><span class=line><span class=cl>│ Type=Dir│            │ Type=Reg│             │ Type=Reg│
</span></span><span class=line><span class=cl>└────┬────┘            └────┬────┘             └────┬────┘
</span></span><span class=line><span class=cl>     │                      │                       │
</span></span><span class=line><span class=cl>     ▼                      ▼                       ▼
</span></span><span class=line><span class=cl>┌─────────┐            ┌─────────┐             ┌─────────┐
</span></span><span class=line><span class=cl>│ Block 0 │            │ Block 1 │             │ Block 2 │
</span></span><span class=line><span class=cl>│ DirEntry│            │ content │             │ content │
</span></span><span class=line><span class=cl>│ a→Inode2│            │  &#34;hello&#34;│             │ &#34;world&#34; │
</span></span><span class=line><span class=cl>│ b→Inode3│            └─────────┘             └─────────┘
</span></span><span class=line><span class=cl>└─────────┘
</span></span></code></pre></td></tr></table></div></div><h2 id=3-fuse-architecture>3. FUSE Architecture</h2><h3 id=31-how-it-works>3.1 How It Works</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌──────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                       User Space                          │
</span></span><span class=line><span class=cl>│  ┌──────────┐    ┌──────────┐    ┌──────────────────┐    │
</span></span><span class=line><span class=cl>│  │ Your App │───▶│  glibc   │───▶│ FUSE userspace   │    │
</span></span><span class=line><span class=cl>│  │ (cat, ls)│    │ open/read│    │ (your code)      │    │
</span></span><span class=line><span class=cl>│  └──────────┘    └────┬─────┘    └────────▲─────────┘    │
</span></span><span class=line><span class=cl>│                       │                    │              │
</span></span><span class=line><span class=cl>└───────────────────────│────────────────────│──────────────┘
</span></span><span class=line><span class=cl>                        │ VFS               │ /dev/fuse
</span></span><span class=line><span class=cl>                        ▼                    │
</span></span><span class=line><span class=cl>┌───────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                       Kernel                              │
</span></span><span class=line><span class=cl>│  ┌──────────────────────────────────────────────────┐    │
</span></span><span class=line><span class=cl>│  │                   FUSE kernel module              │    │
</span></span><span class=line><span class=cl>│  │  (forwards VFS calls to userspace, returns result)│    │
</span></span><span class=line><span class=cl>│  └──────────────────────────────────────────────────┘    │
</span></span><span class=line><span class=cl>└───────────────────────────────────────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><h3 id=32-operations-to-implement>3.2 Operations to Implement</h3><table><thead><tr><th>Operation</th><th>System Call</th><th>Description</th></tr></thead><tbody><tr><td>Lookup</td><td>open(dir)</td><td>Find file in directory</td></tr><tr><td>Getattr</td><td>stat</td><td>Get file attributes</td></tr><tr><td>Readdir</td><td>readdir</td><td>List directory contents</td></tr><tr><td>Read</td><td>read</td><td>Read file content</td></tr><tr><td>Write</td><td>write</td><td>Write file content</td></tr><tr><td>Create</td><td>creat/open</td><td>Create new file</td></tr><tr><td>Mkdir</td><td>mkdir</td><td>Create directory</td></tr><tr><td>Unlink</td><td>unlink</td><td>Delete file</td></tr><tr><td>Rmdir</td><td>rmdir</td><td>Delete directory</td></tr></tbody></table><h2 id=4-go-implementation>4. Go Implementation</h2><h3 id=41-dependencies>4.1 Dependencies</h3><p>Using <code>bazil.org/fuse</code> library:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go get bazil.org/fuse
</span></span></code></pre></td></tr></table></div></div><h3 id=42-data-structures>4.2 Data Structures</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;os&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;sync&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>InodeType</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>const</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>TypeFile</span><span class=w> </span><span class=nx>InodeType</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>iota</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>TypeDir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>MemFS</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mu</span><span class=w>       </span><span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>inodes</span><span class=w>   </span><span class=kd>map</span><span class=p>[</span><span class=kt>uint64</span><span class=p>]</span><span class=o>*</span><span class=nx>Inode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>data</span><span class=w>     </span><span class=kd>map</span><span class=p>[</span><span class=kt>uint64</span><span class=p>][]</span><span class=kt>byte</span><span class=w>  </span><span class=c1>// inode -&gt; file content</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>nextIno</span><span class=w>  </span><span class=kt>uint64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Inode</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ID</span><span class=w>       </span><span class=kt>uint64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Type</span><span class=w>     </span><span class=nx>InodeType</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Mode</span><span class=w>     </span><span class=nx>os</span><span class=p>.</span><span class=nx>FileMode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Size</span><span class=w>     </span><span class=kt>uint64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Atime</span><span class=w>    </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Mtime</span><span class=w>    </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Children</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>uint64</span><span class=w>  </span><span class=c1>// dir entries: name -&gt; inode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewMemFS</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=nx>MemFS</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fs</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>MemFS</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>inodes</span><span class=p>:</span><span class=w>  </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>uint64</span><span class=p>]</span><span class=o>*</span><span class=nx>Inode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>data</span><span class=p>:</span><span class=w>    </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>uint64</span><span class=p>][]</span><span class=kt>byte</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>nextIno</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Create root directory (inode 1)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fs</span><span class=p>.</span><span class=nx>inodes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Inode</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>ID</span><span class=p>:</span><span class=w>       </span><span class=mi>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Type</span><span class=p>:</span><span class=w>     </span><span class=nx>TypeDir</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Mode</span><span class=p>:</span><span class=w>     </span><span class=nx>os</span><span class=p>.</span><span class=nx>ModeDir</span><span class=w> </span><span class=p>|</span><span class=w> </span><span class=mo>0755</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Atime</span><span class=p>:</span><span class=w>    </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Mtime</span><span class=p>:</span><span class=w>    </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Children</span><span class=p>:</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>uint64</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>fs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=43-implementing-fuse-interface>4.3 Implementing FUSE Interface</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;bazil.org/fuse&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;bazil.org/fuse/fs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Dir implements directory node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Dir</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fs</span><span class=w>    </span><span class=o>*</span><span class=nx>MemFS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>inode</span><span class=w> </span><span class=o>*</span><span class=nx>Inode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>d</span><span class=w> </span><span class=o>*</span><span class=nx>Dir</span><span class=p>)</span><span class=w> </span><span class=nf>Attr</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>attr</span><span class=w> </span><span class=o>*</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>Attr</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>attr</span><span class=p>.</span><span class=nx>Inode</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>ID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>attr</span><span class=p>.</span><span class=nx>Mode</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>attr</span><span class=p>.</span><span class=nx>Atime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Atime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>attr</span><span class=p>.</span><span class=nx>Mtime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Mtime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>d</span><span class=w> </span><span class=o>*</span><span class=nx>Dir</span><span class=p>)</span><span class=w> </span><span class=nf>Lookup</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>name</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>fs</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>childIno</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Children</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fuse</span><span class=p>.</span><span class=nx>ENOENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>child</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>inodes</span><span class=p>[</span><span class=nx>childIno</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>child</span><span class=p>.</span><span class=nx>Type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>TypeDir</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Dir</span><span class=p>{</span><span class=nx>fs</span><span class=p>:</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>,</span><span class=w> </span><span class=nx>inode</span><span class=p>:</span><span class=w> </span><span class=nx>child</span><span class=p>},</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>File</span><span class=p>{</span><span class=nx>fs</span><span class=p>:</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>,</span><span class=w> </span><span class=nx>inode</span><span class=p>:</span><span class=w> </span><span class=nx>child</span><span class=p>},</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>d</span><span class=w> </span><span class=o>*</span><span class=nx>Dir</span><span class=p>)</span><span class=w> </span><span class=nf>ReadDirAll</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>([]</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>Dirent</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>entries</span><span class=w> </span><span class=p>[]</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>Dirent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>name</span><span class=p>,</span><span class=w> </span><span class=nx>ino</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Children</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>child</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>inodes</span><span class=p>[</span><span class=nx>ino</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>t</span><span class=w> </span><span class=nx>fuse</span><span class=p>.</span><span class=nx>DirentType</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>child</span><span class=p>.</span><span class=nx>Type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>TypeDir</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>t</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>fuse</span><span class=p>.</span><span class=nx>DT_Dir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>t</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>fuse</span><span class=p>.</span><span class=nx>DT_File</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>entries</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>entries</span><span class=p>,</span><span class=w> </span><span class=nx>fuse</span><span class=p>.</span><span class=nx>Dirent</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Inode</span><span class=p>:</span><span class=w> </span><span class=nx>ino</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Name</span><span class=p>:</span><span class=w>  </span><span class=nx>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Type</span><span class=p>:</span><span class=w>  </span><span class=nx>t</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>entries</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>d</span><span class=w> </span><span class=o>*</span><span class=nx>Dir</span><span class=p>)</span><span class=w> </span><span class=nf>Create</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>*</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>CreateRequest</span><span class=p>,</span><span class=w> </span><span class=nx>resp</span><span class=w> </span><span class=o>*</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>CreateResponse</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>fs</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span><span class=w> </span><span class=nx>fs</span><span class=p>.</span><span class=nx>Handle</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ino</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>nextIno</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>nextIno</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>now</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>inode</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Inode</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>ID</span><span class=p>:</span><span class=w>    </span><span class=nx>ino</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Type</span><span class=p>:</span><span class=w>  </span><span class=nx>TypeFile</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Mode</span><span class=p>:</span><span class=w>  </span><span class=nx>req</span><span class=p>.</span><span class=nx>Mode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Atime</span><span class=p>:</span><span class=w> </span><span class=nx>now</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Mtime</span><span class=p>:</span><span class=w> </span><span class=nx>now</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>inodes</span><span class=p>[</span><span class=nx>ino</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>inode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>data</span><span class=p>[</span><span class=nx>ino</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[]</span><span class=kt>byte</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Children</span><span class=p>[</span><span class=nx>req</span><span class=p>.</span><span class=nx>Name</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ino</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>file</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>File</span><span class=p>{</span><span class=nx>fs</span><span class=p>:</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>,</span><span class=w> </span><span class=nx>inode</span><span class=p>:</span><span class=w> </span><span class=nx>inode</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>file</span><span class=p>,</span><span class=w> </span><span class=nx>file</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>d</span><span class=w> </span><span class=o>*</span><span class=nx>Dir</span><span class=p>)</span><span class=w> </span><span class=nf>Mkdir</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>*</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>MkdirRequest</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>fs</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ino</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>nextIno</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>nextIno</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>now</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>inode</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Inode</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>ID</span><span class=p>:</span><span class=w>       </span><span class=nx>ino</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Type</span><span class=p>:</span><span class=w>     </span><span class=nx>TypeDir</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Mode</span><span class=p>:</span><span class=w>     </span><span class=nx>req</span><span class=p>.</span><span class=nx>Mode</span><span class=w> </span><span class=p>|</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nx>ModeDir</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Atime</span><span class=p>:</span><span class=w>    </span><span class=nx>now</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Mtime</span><span class=p>:</span><span class=w>    </span><span class=nx>now</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Children</span><span class=p>:</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>uint64</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>inodes</span><span class=p>[</span><span class=nx>ino</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>inode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Children</span><span class=p>[</span><span class=nx>req</span><span class=p>.</span><span class=nx>Name</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ino</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Dir</span><span class=p>{</span><span class=nx>fs</span><span class=p>:</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>fs</span><span class=p>,</span><span class=w> </span><span class=nx>inode</span><span class=p>:</span><span class=w> </span><span class=nx>inode</span><span class=p>},</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=44-file-operations>4.4 File Operations</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// File implements file node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>File</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fs</span><span class=w>    </span><span class=o>*</span><span class=nx>MemFS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>inode</span><span class=w> </span><span class=o>*</span><span class=nx>Inode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>f</span><span class=w> </span><span class=o>*</span><span class=nx>File</span><span class=p>)</span><span class=w> </span><span class=nf>Attr</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>attr</span><span class=w> </span><span class=o>*</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>Attr</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>attr</span><span class=p>.</span><span class=nx>Inode</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>ID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>attr</span><span class=p>.</span><span class=nx>Mode</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>attr</span><span class=p>.</span><span class=nx>Size</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Size</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>attr</span><span class=p>.</span><span class=nx>Atime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Atime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>attr</span><span class=p>.</span><span class=nx>Mtime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Mtime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>f</span><span class=w> </span><span class=o>*</span><span class=nx>File</span><span class=p>)</span><span class=w> </span><span class=nf>Read</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>*</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>ReadRequest</span><span class=p>,</span><span class=w> </span><span class=nx>resp</span><span class=w> </span><span class=o>*</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>ReadResponse</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>f</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>data</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>data</span><span class=p>[</span><span class=nx>f</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>ID</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>Offset</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>end</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>Offset</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Size</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>end</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>resp</span><span class=p>.</span><span class=nx>Data</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>data</span><span class=p>[</span><span class=nx>req</span><span class=p>.</span><span class=nx>Offset</span><span class=p>:</span><span class=nx>end</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>f</span><span class=w> </span><span class=o>*</span><span class=nx>File</span><span class=p>)</span><span class=w> </span><span class=nf>Write</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>*</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>WriteRequest</span><span class=p>,</span><span class=w> </span><span class=nx>resp</span><span class=w> </span><span class=o>*</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>WriteResponse</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>f</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>data</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>data</span><span class=p>[</span><span class=nx>f</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>ID</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Extend file size</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>newLen</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Offset</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Data</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>newLen</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>newData</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=nx>newLen</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>copy</span><span class=p>(</span><span class=nx>newData</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>data</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>newData</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>copy</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=nx>req</span><span class=p>.</span><span class=nx>Offset</span><span class=p>:],</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>Data</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>f</span><span class=p>.</span><span class=nx>fs</span><span class=p>.</span><span class=nx>data</span><span class=p>[</span><span class=nx>f</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>ID</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>f</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Size</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>uint64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>f</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>Mtime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>resp</span><span class=p>.</span><span class=nx>Size</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Data</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=45-main-program>4.5 Main Program</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mountpoint</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>&#34;/tmp/memfs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>os</span><span class=p>.</span><span class=nf>MkdirAll</span><span class=p>(</span><span class=nx>mountpoint</span><span class=p>,</span><span class=w> </span><span class=mo>0755</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>fuse</span><span class=p>.</span><span class=nf>Mount</span><span class=p>(</span><span class=nx>mountpoint</span><span class=p>,</span><span class=w> </span><span class=nx>fuse</span><span class=p>.</span><span class=nf>FSName</span><span class=p>(</span><span class=s>&#34;memfs&#34;</span><span class=p>),</span><span class=w> </span><span class=nx>fuse</span><span class=p>.</span><span class=nf>Subtype</span><span class=p>(</span><span class=s>&#34;memfs&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Mounted at %s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>mountpoint</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Press Ctrl+C to exit&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>memfs</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>NewMemFS</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Handle signals for graceful unmount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sigChan</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>sigChan</span><span class=p>,</span><span class=w> </span><span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span><span class=w> </span><span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&lt;-</span><span class=nx>sigChan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fuse</span><span class=p>.</span><span class=nf>Unmount</span><span class=p>(</span><span class=nx>mountpoint</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>fs</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>FS</span><span class=p>{</span><span class=nx>memfs</span><span class=p>:</span><span class=w> </span><span class=nx>memfs</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>FS</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>memfs</span><span class=w> </span><span class=o>*</span><span class=nx>MemFS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>f</span><span class=w> </span><span class=o>*</span><span class=nx>FS</span><span class=p>)</span><span class=w> </span><span class=nf>Root</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>fs</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Dir</span><span class=p>{</span><span class=nx>fs</span><span class=p>:</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>memfs</span><span class=p>,</span><span class=w> </span><span class=nx>inode</span><span class=p>:</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>memfs</span><span class=p>.</span><span class=nx>inodes</span><span class=p>[</span><span class=mi>1</span><span class=p>]},</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=5-test-run>5. Test Run</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Build and run</span>
</span></span><span class=line><span class=cl>go build -o memfs
</span></span><span class=line><span class=cl>./memfs <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Test file operations</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /tmp/memfs
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;hello world&#34;</span> &gt; test.txt
</span></span><span class=line><span class=cl>cat test.txt
</span></span><span class=line><span class=cl>mkdir subdir
</span></span><span class=line><span class=cl>ls -la
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Unmount</span>
</span></span><span class=line><span class=cl>fusermount -u /tmp/memfs
</span></span></code></pre></td></tr></table></div></div><h2 id=6-advanced-extensions>6. Advanced Extensions</h2><h3 id=61-persist-to-disk>6.1 Persist to Disk</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Serialize inodes and data to disk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>fs</span><span class=w> </span><span class=o>*</span><span class=nx>MemFS</span><span class=p>)</span><span class=w> </span><span class=nf>SaveToDisk</span><span class=p>(</span><span class=nx>path</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>f</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>path</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>gob</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>f</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>fs</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>LoadFromDisk</span><span class=p>(</span><span class=nx>path</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>MemFS</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>f</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>path</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=nx>MemFS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>gob</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>f</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>fs</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>fs</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=62-network-filesystem>6.2 Network Filesystem</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Forward read/write to remote server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>f</span><span class=w> </span><span class=o>*</span><span class=nx>File</span><span class=p>)</span><span class=w> </span><span class=nf>Read</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>*</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>ReadRequest</span><span class=p>,</span><span class=w> </span><span class=nx>resp</span><span class=w> </span><span class=o>*</span><span class=nx>fuse</span><span class=p>.</span><span class=nx>ReadResponse</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Read from remote via gRPC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>data</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>f</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>ReadRequest</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Inode</span><span class=p>:</span><span class=w>  </span><span class=nx>f</span><span class=p>.</span><span class=nx>inode</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Offset</span><span class=p>:</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>Offset</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Size</span><span class=p>:</span><span class=w>   </span><span class=nb>int64</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Size</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>resp</span><span class=p>.</span><span class=nx>Data</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>data</span><span class=p>.</span><span class=nx>Content</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=7-summary>7. Summary</h2><table><thead><tr><th>Concept</th><th>Implementation</th></tr></thead><tbody><tr><td>Inode</td><td>Struct storing metadata</td></tr><tr><td>Block</td><td>byte slice storing data</td></tr><tr><td>Directory</td><td>map[name]inode</td></tr><tr><td>FUSE</td><td>Implement Attr/Read/Write interfaces</td></tr></tbody></table><p><strong>Takeaways</strong>:</p><ol><li>Deep understanding of inode and directory entry relationship</li><li>Learned VFS to FUSE call chain</li><li>Foundation for understanding distributed storage</li></ol><hr><blockquote><p><strong>Related Posts</strong></p><ul><li><a href=/posts/210520-linux-boot-process/ rel>Linux Boot Process: Complete Guide from Power Button to Login</a></li></ul></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-08-10</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://uzqw.github.io/posts/210810-fuse-filesystem/ data-title="Building a Mini Filesystem: Custom FS with FUSE + Go" data-hashtags=Filesystem,FUSE,Go><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://uzqw.github.io/posts/210810-fuse-filesystem/ data-hashtag=Filesystem><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://uzqw.github.io/posts/210810-fuse-filesystem/ data-title="Building a Mini Filesystem: Custom FS with FUSE + Go"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://uzqw.github.io/posts/210810-fuse-filesystem/ data-title="Building a Mini Filesystem: Custom FS with FUSE + Go"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://uzqw.github.io/posts/210810-fuse-filesystem/ data-title="Building a Mini Filesystem: Custom FS with FUSE + Go"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/filesystem/>Filesystem</a>,&nbsp;<a href=/tags/fuse/>FUSE</a>,&nbsp;<a href=/tags/go/>Go</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/210703-lru-learning/ class=prev rel=prev title="Redis Eviction Deep Dive: LRU vs LFU vs TTL Engineering Trade-offs"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Redis Eviction Deep Dive: LRU vs LFU vs TTL Engineering Trade-offs</a>
<a href=/posts/210922-go-feature/ class=next rel=next title="Go Microservices War Stories: 5 Lessons from Dependency Management to Service Discovery">Go Microservices War Stories: 5 Lessons from Dependency Management to Service Discovery<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2026</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>xxxx</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:999},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOQtuhcM4C0KhX",darkTheme:"dark",emitMetadata:"0",inputPosition:"bottom",lang:"en",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"uzqw/uzqw.github.io-comments",repoId:"R_kgDOQtuhcA"}},search:{algoliaAppID:"3I0XV796PJ",algoliaIndex:"uzqw_blog_en",algoliaSearchKey:"a9b525cdbc6c909379811b8e4440f85d",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>